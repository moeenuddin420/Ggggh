<!DOCTYPE html>
<html lang="bn">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>G-ZONE ESPORTS</title>
    
    <!-- PWA MANIFEST (REQUIRED) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <link href="https://fonts.googleapis.com/css2?family=Hind+Siliguri:wght@300;400;500;600;700&family=Rajdhani:wght@400;600;700&family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- VARIABLES & RESET --- */
        :root {
            --primary: #00f2ff; --primary-dark: #009eb3; --secondary: #6c35de; --accent: #ff0055;
            --success: #00ff9d; --warning: #ffcc00; --danger: #ff2e63; --bg-dark: #13132b;
            --glass-bg: rgba(30, 30, 50, 0.7); --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #ffffff; --text-muted: #a0a0b0;
            --font-main: 'Outfit', sans-serif; --font-bn: 'Hind Siliguri', sans-serif; --font-gaming: 'Rajdhani', sans-serif;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; outline: none; }
        
        body {
            background: linear-gradient(135deg, #1a1a3a, #16213e, #1f1f3d);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: var(--text-main);
            font-family: var(--font-bn);
            min-height: 100vh;
            overflow-x: hidden;
            padding-bottom: 20px;
            position: relative;
        }

        @keyframes gradientBG { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        .bg-animation { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1; overflow: hidden; pointer-events: none; }
        .orb { position: absolute; border-radius: 50%; filter: blur(90px); opacity: 0.3; animation: floatOrb 10s infinite alternate; }
        .orb-1 { top: -10%; left: -10%; width: 300px; height: 300px; background: var(--secondary); animation-duration: 12s; }
        .orb-2 { bottom: 10%; right: -10%; width: 250px; height: 250px; background: var(--primary-dark); animation-duration: 15s; }
        @keyframes floatOrb { 0% { transform: translate(0, 0) scale(1); } 100% { transform: translate(30px, 50px) scale(1.1); } }

        .hidden { display: none !important; }

        /* UI ELEMENTS */
        .btn { width: 100%; padding: 12px; border: none; border-radius: 12px; cursor: pointer; font-weight: 700; font-size: 1rem; display: flex; align-items: center; justify-content: center; gap: 8px; transition: 0.2s; }
        .btn-primary { background: linear-gradient(90deg, var(--primary), var(--secondary)); color: #fff; box-shadow: 0 4px 15px rgba(0, 242, 255, 0.3); text-decoration: none; }
        .btn-secondary { background: rgba(255, 255, 255, 0.1); color: var(--text-main); border: 1px solid var(--glass-border); }
        .btn-success { background: var(--success); color: #000; font-weight: 800; }
        .btn-danger { background: var(--danger); color: #fff; }

        .input-group { position: relative; margin-bottom: 20px; }
        .input-group i { position: absolute; top: 50%; left: 16px; transform: translateY(-50%); color: var(--primary); font-size: 1.1rem; z-index: 2; }
        .input-group input { width: 100%; padding: 16px 16px 16px 50px; background: rgba(20, 20, 40, 0.6); border: 1px solid var(--glass-border); border-radius: 14px; color: #fff; font-size: 1rem; transition: 0.3s; }
        .input-group input:focus { border-color: var(--primary); background: rgba(20, 20, 40, 0.9); }

        /* --- HEADER --- */
        header { 
            background: rgba(20, 20, 40, 0.95); 
            backdrop-filter: blur(20px); 
            padding: 10px 15px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100; 
            border-bottom: 1px solid var(--glass-border); 
            height: 70px;
        }
        
        .header-left { display: flex; align-items: center; gap: 15px; }
        .logo { font-family: var(--font-gaming); font-size: 1.6rem; font-weight: 700; color: var(--primary); letter-spacing: 1px; }
        
        .header-right { display: flex; align-items: center; gap: 10px; }
        
        .nav-balance {
            background: rgba(0, 255, 157, 0.1);
            border: 1px solid var(--success);
            padding: 6px 12px;
            border-radius: 20px;
            font-family: var(--font-gaming);
            font-weight: 700;
            color: #fff;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 1.1rem;
            cursor: pointer;
            transition: 0.3s;
        }
        .nav-balance:active { transform: scale(0.95); background: rgba(0, 255, 157, 0.2); }
        .nav-balance i { color: var(--success); font-size: 0.9rem; }

        .notif-icon-box { position: relative; width: 40px; height: 40px; display: flex; align-items: center; justify-content: center; background: rgba(255,255,255,0.1); border-radius: 12px; border: 1px solid var(--glass-border); cursor: pointer; }
        .notification-dot { position: absolute; top: -2px; right: -2px; width: 10px; height: 10px; background: var(--danger); border-radius: 50%; display: none; animation: pulseRed 2s infinite; }
        @keyframes pulseRed { 0% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 46, 99, 0.7); } 70% { transform: scale(1); box-shadow: 0 0 0 6px rgba(255, 46, 99, 0); } 100% { transform: scale(0.9); box-shadow: 0 0 0 0 rgba(255, 46, 99, 0); } }

        /* QUICK ACTIONS */
        .quick-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin: 20px 20px; }
        .q-btn { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); padding: 15px; border-radius: 16px; display: flex; align-items: center; justify-content: center; gap: 10px; color: #fff; font-weight: 600; transition: 0.3s; cursor: pointer; }
        .q-btn:hover { background: rgba(255,255,255,0.1); border-color: var(--primary); }
        .q-btn i { font-size: 1.2rem; }
        .q-add i { color: var(--success); }
        .q-wd i { color: var(--warning); }

        .t-card { background: var(--glass-bg); backdrop-filter: blur(12px); border: 1px solid var(--glass-border); margin: 0 20px 25px; border-radius: 20px; overflow: hidden; position: relative; transition: transform 0.3s; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .t-card:hover { transform: translateY(-3px); border-color: var(--primary); }
        .t-img-wrap { position: relative; height: 160px; overflow: hidden; }
        .t-img { width: 100%; height: 100%; object-fit: cover; transition: 0.5s; }
        .t-card:hover .t-img { transform: scale(1.05); }
        .t-overlay { position: absolute; bottom: 0; left: 0; width: 100%; background: linear-gradient(to top, rgba(19, 19, 43, 0.95), transparent); padding: 20px 15px 10px; }
        .t-title { color: #fff; font-size: 1.2rem; font-weight: 700; text-shadow: 0 2px 4px rgba(0,0,0,0.8); }
        .t-body { padding: 15px; }
        .t-stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; background: rgba(255,255,255,0.05); border-radius: 12px; padding: 10px; margin-bottom: 15px; }
        .t-stat { text-align: center; }
        .t-stat small { display: block; font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; }
        .t-stat b { display: block; font-size: 1rem; color: var(--primary); font-family: var(--font-gaming); }
        .t-actions { display: flex; gap: 10px; }
        
        .t-type-badge { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: var(--primary); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: bold; border: 1px solid var(--primary); text-transform: uppercase; }

        #banner-slider { display: flex; gap: 15px; overflow-x: auto; margin: 0 20px 30px; padding-bottom: 5px; scroll-snap-type: x mandatory; scroll-behavior: smooth; }
        #banner-slider::-webkit-scrollbar { display: none; }
        .slide { min-width: 100%; height: 180px; border-radius: 20px; object-fit: cover; scroll-snap-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.5); border: 1px solid var(--glass-border); }

        .drawer-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); backdrop-filter: blur(5px); z-index: 200; display: none; }
        .drawer { position: fixed; top: 0; left: 0; width: 280px; height: 100%; background: #161b2e; z-index: 201; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; box-shadow: 10px 0 30px rgba(0,0,0,0.5); }
        .drawer.open { transform: translateX(0); }
        .drawer-header { padding: 30px 20px; background: linear-gradient(135deg, var(--secondary), #13132b); text-align: center; border-bottom: 1px solid var(--glass-border); flex-shrink: 0; }
        .drawer-header h2 { font-family: var(--font-gaming); font-size: 2rem; color: #fff; margin: 0; }
        
        .drawer-items { padding: 20px; flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--primary) rgba(255,255,255,0.05); }
        .drawer-footer { padding: 20px; border-top: 1px solid rgba(255,255,255,0.1); flex-shrink: 0; background: #161b2e; box-shadow: 0 -5px 20px rgba(0,0,0,0.5); }
        .d-item { padding: 16px; margin-bottom: 12px; background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01)); border: 1px solid rgba(255, 255, 255, 0.08); border-radius: 14px; color: #e0e0e0; font-size: 1rem; font-weight: 600; display: flex; align-items: center; gap: 15px; transition: all 0.3s ease; cursor: pointer; font-family: var(--font-bn); position: relative; overflow: hidden; }
        .d-item i { width: 25px; text-align: center; color: var(--primary); font-size: 1.2rem; }
        .d-item:hover { background: rgba(0, 242, 255, 0.1); border-color: var(--primary); transform: translateX(5px); box-shadow: 0 4px 15px rgba(0,0,0,0.2); }

        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); backdrop-filter: blur(8px); z-index: 300; display: flex; align-items: center; justify-content: center; opacity: 0; pointer-events: none; transition: 0.3s; }
        .modal:not(.hidden) { opacity: 1; pointer-events: auto; }
        .modal-content { background: #1a1a3a; width: 90%; max-width: 400px; padding: 30px; border-radius: 24px; position: relative; border: 1px solid var(--primary); transform: scale(0.9); transition: 0.3s; }
        .modal:not(.hidden) .modal-content { transform: scale(1); }
        .close-modal { position: absolute; top: 20px; right: 20px; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; }

        .cred-panel { background: rgba(0, 255, 157, 0.08); border: 1px solid var(--success); border-radius: 16px; padding: 15px; margin-top: 15px; position: relative; overflow: hidden; }
        .cred-box { display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.3); padding: 10px 15px; border-radius: 10px; margin-bottom: 10px; border: 1px dashed rgba(0, 255, 157, 0.3); }
        .cred-label { color: var(--success); font-weight: bold; font-size: 0.9rem; }
        .cred-value { color: #fff; font-family: monospace; font-size: 1.1rem; letter-spacing: 1px; }

        .page-section { display: none; padding-top: 10px; animation: fadeIn 0.4s ease; }
        .page-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .section-header { display: flex; align-items: center; gap: 10px; margin: 25px 20px 15px; font-size: 1.2rem; font-weight: 700; color: #fff; text-transform: uppercase; letter-spacing: 1px; }
        .section-header i { color: var(--primary); }
        .profile-img-container { position: relative; width: 120px; height: 120px; margin: 0 auto 20px; }
        .profile-pic { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary); padding: 3px; background: #16162a; }
        
        #loading-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #13132b; z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .loader-box { width: 60px; height: 60px; border: 3px solid rgba(0, 242, 255, 0.2); border-top-color: var(--primary); border-radius: 50%; animation: spin 1s linear infinite; }
        .loader-text { margin-top: 15px; color: var(--primary); font-family: var(--font-gaming); letter-spacing: 2px; animation: pulse 1.5s infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 50% { opacity: 0.5; } }

        #toast-box { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.9); border: 1px solid var(--primary); color: #fff; padding: 12px 25px; border-radius: 30px; z-index: 10000; display: none; align-items: center; gap: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.5); font-family: var(--font-bn); white-space: nowrap; }
        #toast-box.show { display: flex; animation: fadeUp 0.3s ease; }
        
        .sq-tabs { display: flex; gap: 10px; margin-bottom: 15px; }
        .sq-tab { flex: 1; padding: 10px; text-align: center; background: rgba(255,255,255,0.05); border-radius: 8px; cursor: pointer; border: 1px solid transparent; color: #aaa; }
        .sq-tab.active { background: var(--primary); color: #000; font-weight: bold; }

        /* Tournament Tabs */
        .home-tabs { display: flex; margin: 0 20px 20px; background: rgba(255,255,255,0.05); padding: 5px; border-radius: 12px; }
        .home-tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; color: #aaa; border-radius: 8px; font-weight: 600; transition: 0.3s; }
        .home-tab.active { background: var(--primary); color: #161b2e; box-shadow: 0 2px 10px rgba(0, 242, 255, 0.3); }

        /* Payment Methods */
        .method-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .method-card { background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); border-radius: 16px; padding: 15px 5px; text-align: center; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .method-card:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); }
        .method-card.active { border-color: var(--primary); background: rgba(0, 242, 255, 0.1); box-shadow: 0 0 15px rgba(0, 242, 255, 0.2); }
        .method-card img { width: 40px; height: 40px; object-fit: contain; margin-bottom: 8px; }
        .method-card .m-name { font-size: 0.9rem; font-weight: 700; display: block; }
        .method-card input { position: absolute; opacity: 0; cursor: pointer; }
        .m-bkash { color: #e2136e; } .m-nagad { color: #f79c1e; } .m-niva { color: #00ff9d; } .m-payeer { color: #00aaff; }

        .video-card { background: var(--glass-bg); border: 1px solid var(--glass-border); border-radius: 16px; overflow: hidden; margin-bottom: 15px; }
        .video-title { padding: 12px 15px; font-weight: 600; color: #fff; font-size: 1rem; }

        /* Spin Wheel */
        .wheel-container { position: relative; width: 300px; height: 300px; margin: 0 auto; }
        .wheel-rim { width: 100%; height: 100%; border-radius: 50%; background: #121212; padding: 12px; box-shadow: 0 0 0 4px #222, 0 0 25px rgba(0, 242, 255, 0.6), inset 0 0 20px #000; position: relative; }
        .rim-lights { position: absolute; top: 0; left: 0; width: 100%; height: 100%; border-radius: 50%; border: 2px dashed rgba(255,255,255,0.3); animation: rotateLights 20s linear infinite; }
        @keyframes rotateLights { to { transform: rotate(360deg); } }
        .wheel { width: 100%; height: 100%; border-radius: 50%; border: 2px solid #fff; position: relative; overflow: hidden; background: conic-gradient(#ff2e63 0deg 90deg, #ff9900 90deg 180deg, #6c35de 180deg 270deg, #00ff9d 270deg 360deg); transition: transform 5s cubic-bezier(0.25, 0.1, 0.25, 1); transform: rotate(0deg); box-shadow: inset 0 0 20px rgba(0,0,0,0.5); }
        .wheel-text { position: absolute; top: 50%; left: 50%; color: #fff; font-weight: 800; font-family: var(--font-bn); font-size: 1.4rem; text-shadow: 0 2px 4px rgba(0,0,0,0.8); pointer-events: none; white-space: nowrap; width: 100px; text-align: center; }
        .wt-lose { transform: translate(-50%, -50%) rotate(45deg) translateY(-85px) rotate(-45deg); }
        .wt-one { transform: translate(-50%, -50%) rotate(135deg) translateY(-85px) rotate(-135deg); }
        .wt-triple { transform: translate(-50%, -50%) rotate(225deg) translateY(-85px) rotate(-225deg); }
        .wt-double { transform: translate(-50%, -50%) rotate(315deg) translateY(-85px) rotate(-315deg); color: #000; }
        .wheel::after { content: ''; position: absolute; top:0; left:0; width:100%; height:100%; border-radius:50%; background: linear-gradient(0deg, transparent 49%, rgba(0,0,0,0.5) 50%, transparent 51%), linear-gradient(90deg, transparent 49%, rgba(0,0,0,0.5) 50%, transparent 51%); pointer-events: none; }
        .wheel-pointer { position: absolute; top: -25px; left: 50%; transform: translateX(-50%); width: 40px; height: 50px; background: radial-gradient(circle at top, #fff, #ccc); clip-path: polygon(0 0, 100% 0, 50% 100%); z-index: 10; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.7)); }
        .wheel-center { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 50px; height: 50px; background: #fff; border-radius: 50%; border: 4px solid #121212; display: flex; align-items: center; justify-content: center; font-weight: 800; color: #121212; box-shadow: 0 0 10px rgba(0,0,0,0.5); z-index: 5; }
        .caution-box { background: rgba(255, 46, 99, 0.15); border: 1px solid var(--danger); border-radius: 12px; padding: 15px; margin-top: 25px; color: #ffcccc; font-size: 0.95rem; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.3); }

        .rank-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 15px; background: rgba(255,255,255,0.05); border-radius: 12px; margin-bottom: 8px; border: 1px solid transparent; }
        .rank-item.top-1 { border-color: #ffd700; background: rgba(255, 215, 0, 0.1); }
        .rank-item.top-2 { border-color: #c0c0c0; background: rgba(192, 192, 192, 0.1); }
        .rank-item.top-3 { border-color: #cd7f32; background: rgba(205, 127, 50, 0.1); }
        .rank-left { display: flex; align-items: center; gap: 15px; }
        .rank-pos { font-weight: bold; font-family: var(--font-gaming); font-size: 1.2rem; width: 25px; color: var(--text-muted); }
        .top-1 .rank-pos { color: #ffd700; } .top-2 .rank-pos { color: #c0c0c0; } .top-3 .rank-pos { color: #cd7f32; }
    </style>
</head>
<body>
    <div class="bg-animation"><div class="orb orb-1"></div><div class="orb orb-2"></div></div>
    <div id="loading-overlay"><div class="loader-box"></div><div class="loader-text">SYSTEM LOADING...</div></div>
    <div id="toast-box"><i class="fas fa-info-circle" style="color:var(--primary)"></i> <span id="toast-msg"></span></div>

    <!-- AUTH -->
    <div id="auth-container" class="hidden" style="display:flex;flex-direction:column;justify-content:center;padding:30px;min-height:100vh;text-align:center; backdrop-filter:blur(5px);">
        <h1 class="logo" style="font-size:3rem; margin-bottom:10px;">G-ZONE</h1>
        <div id="login-form">
            <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="l-email" placeholder="ইমেইল"></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="l-pass" placeholder="পাসওয়ার্ড"></div>
            <button class="btn btn-primary" onclick="login()">লগইন করুন</button>
            <p style="margin-top:20px;color:#aaa;cursor:pointer" onclick="toggleAuth()">একাউন্ট খুলুন</p>
        </div>
        <div id="signup-form" class="hidden">
            <div class="input-group"><i class="fas fa-user"></i><input type="text" id="r-user" placeholder="পুরো নাম (Full Name)"></div>
            <div class="input-group"><i class="fas fa-envelope"></i><input type="email" id="r-email" placeholder="ইমেইল"></div>
            <div class="input-group"><i class="fas fa-lock"></i><input type="password" id="r-pass" placeholder="পাসওয়ার্ড"></div>
            <div class="input-group"><i class="fas fa-gift"></i><input type="text" id="r-refer" placeholder="রেফার কোড (Optional)"></div>
            <button class="btn btn-primary" onclick="register()">রেজিস্ট্রেশন</button>
            <p style="margin-top:20px;color:#aaa;cursor:pointer" onclick="toggleAuth()">লগইন করুন</p>
        </div>
    </div>

    <!-- APP -->
    <div id="app-container" class="hidden">
        
        <!-- HEADER -->
        <header>
            <div class="header-left">
                <i class="fas fa-bars fa-lg" onclick="toggleDrawer()" style="cursor:pointer; color:var(--primary);"></i>
                <div class="logo">G-ZONE</div>
            </div>
            
            <div class="header-right">
                <div class="nav-balance" onclick="nav('page-withdraw')">
                    <i class="fas fa-wallet"></i>
                    <span>৳<span id="header-bal">0</span></span>
                </div>
                
                <div class="notif-icon-box" onclick="openNotifications()">
                    <i class="fas fa-bell" style="color:#fff;"></i>
                    <div id="header-badge" class="notification-dot"></div>
                </div>
            </div>
        </header>

        <!-- HOME -->
        <div id="page-home" class="page-section active">
            <div class="quick-actions">
                <div class="q-btn q-add" onclick="nav('page-add-money')">
                    <i class="fas fa-plus-circle"></i> এড মানি
                </div>
                <div class="q-btn q-wd" onclick="nav('page-withdraw')">
                    <i class="fas fa-money-bill-wave"></i> উইথড্র
                </div>
            </div>
            <div id="banner-slider"></div>
            <div class="section-header"><i class="fas fa-trophy"></i> চলমান টুর্নামেন্ট</div>
            <div class="home-tabs">
                <div class="home-tab active" id="ht-BR" onclick="switchHomeTab('BR')">Battle Royale (BR)</div>
                <div class="home-tab" id="ht-CS" onclick="switchHomeTab('CS')">Clash Squad (CS)</div>
            </div>
            <div id="tournament-list"></div>
        </div>

        <!-- LEADERBOARD -->
        <div id="page-leaderboard" class="page-section">
            <div class="section-header"><i class="fas fa-crown"></i> সেরা ১০ ধনী</div>
            <div class="t-card"><div class="t-body"><div id="balance-leaderboard"></div></div></div>
        </div>

        <!-- REFERRAL -->
        <div id="page-refer" class="page-section">
            <div class="section-header"><i class="fas fa-user-plus"></i> রেফার করুন</div>
            <div class="t-card">
                <div class="t-body" style="text-align:center;">
                    <p style="color:var(--text-muted);">আপনার রেফার কোড</p>
                    <div class="cred-panel" style="margin:15px 0;">
                        <div class="cred-box" style="justify-content:center; gap:10px;">
                            <span id="my-refer-code" class="cred-value" style="font-size:1.8rem;">...</span>
                            <i class="fas fa-copy" onclick="copyReferCode()" style="cursor:pointer; color:var(--primary)"></i>
                        </div>
                    </div>
                    <p style="font-size:0.9rem; color:#aaa; margin-bottom:20px;">বন্ধুদের ইনভাইট করুন। তারা যখন তাদের প্রথম সোলো ম্যাচে জয়েন করবে, আপনি পাবেন <span style="color:var(--success)">৳5</span> বোনাস!</p>
                    <div style="display:flex; justify-content:space-around; background:rgba(255,255,255,0.05); padding:10px; border-radius:12px;">
                        <div><small style="color:var(--text-muted)">মোট রেফার</small><h3 id="total-refers">0</h3></div>
                        <div><small style="color:var(--text-muted)">মোট আয়</small><h3 id="total-refer-earn">৳0</h3></div>
                    </div>
                </div>
            </div>
            <div class="section-header"><i class="fas fa-medal"></i> টপ রেফারার (লাইভ)</div>
            <div id="referral-leaderboard" style="margin: 0 20px 20px;"></div>
        </div>

        <!-- SPIN WHEEL -->
        <div id="page-spin" class="page-section">
            <div class="section-header"><i class="fas fa-dharmachakra"></i> লাকি স্পিন</div>
            <div class="t-card">
                <div class="t-body" style="text-align:center; padding: 30px 10px;">
                    <div class="wheel-container">
                        <div class="wheel-pointer"></div>
                        <div class="wheel-rim">
                            <div class="rim-lights"></div>
                            <div id="spin-wheel" class="wheel">
                                <span class="wheel-text wt-lose">লস</span>
                                <span class="wheel-text wt-one">১ গুণ</span>
                                <span class="wheel-text wt-triple">৩ গুণ</span>
                                <span class="wheel-text wt-double">২ গুণ</span>
                            </div>
                        </div>
                        <div class="wheel-center"><i class="fas fa-star"></i></div>
                    </div>
                    <div class="caution-box">
                        <i class="fas fa-exclamation-triangle"></i> <b>সতর্কবার্তা</b><br>
                        এই খেলায় আর্থিক ঝুঁকি আছে। স্পিনে টাকা হারানো গেলে কর্তৃপক্ষ বা অ্যাডমিন দায়ী থাকবে না। নিজ দায়িত্বে খেলুন।
                    </div>
                    <div class="input-group" style="margin-top:20px;">
                        <i class="fas fa-coins"></i>
                        <input type="number" id="spin-amt" placeholder="টাকার পরিমাণ লিখুন">
                    </div>
                    <button class="btn btn-primary" id="spin-btn" onclick="spinWheel()">স্পিন করুন</button>
                </div>
            </div>
        </div>

        <!-- MATCHES -->
        <div id="page-matches" class="page-section">
            <div class="section-header"><i class="fas fa-gamepad"></i> আমার ম্যাচ</div>
            <div id="my-matches-list"></div>
        </div>

        <!-- PROFILE -->
        <div id="page-profile" class="page-section">
            <div class="section-header"><i class="fas fa-user-astronaut"></i> প্রোফাইল</div>
            <div class="t-card">
                <div class="t-body" style="text-align:center; padding:40px 20px;">
                    <div class="profile-img-container"><img id="p-pic" src="" class="profile-pic" onerror="this.src='https://via.placeholder.com/100'"></div>
                    <h2 style="color:#fff; margin-bottom:5px;"><span id="p-name">...</span></h2>
                    <div style="background:rgba(255,255,255,0.1); padding:8px 15px; border-radius:20px; display:inline-flex; align-items:center; gap:10px; margin:10px 0;">
                        <span style="color:#aaa; font-size:0.9rem;">ID:</span>
                        <span id="p-custom-id" style="font-family:monospace; font-weight:bold; letter-spacing:1px; color:var(--primary);">...</span>
                        <i class="fas fa-copy" onclick="copyCustomId()" style="cursor:pointer; color:var(--primary);"></i>
                    </div>
                    <div style="margin-top:30px; text-align:left;">
                        <div class="input-group"><i class="fas fa-link"></i><input type="text" id="new-pic-url" placeholder="ছবির URL"></div>
                        <button class="btn btn-primary" onclick="updateProfilePic()">আপডেট করুন</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- TRANSFER -->
        <div id="page-transfer" class="page-section">
            <div class="section-header"><i class="fas fa-exchange-alt"></i> টাকা ট্রান্সফার</div>
            <div class="t-card">
                <div class="t-body">
                    <p style="color:var(--text-muted); margin-bottom:15px;">অন্য ইউজারকে টাকা পাঠান:</p>
                    <div class="input-group"><i class="fas fa-id-card"></i><input type="number" id="tf-id" placeholder="রিসিভারের ইউজার আইডি (১১ সংখ্যা)"></div>
                    <div class="input-group"><i class="fas fa-coins"></i><input type="number" id="tf-amount" placeholder="টাকার পরিমাণ"></div>
                    <button class="btn btn-primary" id="btn-transfer" onclick="sendMoney()">টাকা পাঠান</button>
                </div>
            </div>
            <div style="margin:20px; font-size:0.85rem; color:#aaa; text-align:center;">
                <i class="fas fa-info-circle"></i> ভুল আইডিতে টাকা পাঠালে ফেরত পাওয়া যাবে না। আইডি চেক করে নিন।
            </div>
        </div>

        <!-- WITHDRAW (UPDATED WITH PAYEER) -->
        <div id="page-withdraw" class="page-section">
            <div class="section-header"><i class="fas fa-money-bill-wave"></i> উইথড্র</div>
            <div class="t-card"><div class="t-body">
                <p style="color:var(--text-muted); margin-bottom:15px;">মেথড সিলেক্ট করুন:</p>
                <div class="method-grid">
                    <label class="method-card" id="method-bkash" onclick="selectMethod(this)">
                        <input type="radio" name="w_method" value="Bkash">
                        <img src="https://raw.githubusercontent.com/Shipu/bkash-example/master/bkash_payment_logo.png" alt="Bkash">
                        <span class="m-name m-bkash">বিকাশ</span>
                    </label>
                    <label class="method-card" id="method-nagad" onclick="selectMethod(this)">
                        <input type="radio" name="w_method" value="Nagad">
                        <img src="https://download.logo.wine/logo/Nagad/Nagad-Vertical-Logo.wine.png" alt="Nagad">
                        <span class="m-name m-nagad">নগদ</span>
                    </label>
                    <label class="method-card" id="method-niva" onclick="selectMethod(this)">
                        <input type="radio" name="w_method" value="Niva Coin">
                        <i class="fas fa-coins fa-2x" style="color:#00ff9d; margin-bottom:8px;"></i>
                        <span class="m-name m-niva">নিভা কয়েন</span>
                    </label>
                    <!-- NEW PAYEER OPTION -->
                    <label class="method-card" id="method-payeer" onclick="selectMethod(this)">
                        <input type="radio" name="w_method" value="Payeer Dollar">
                        <i class="fas fa-dollar-sign fa-2x" style="color:#00aaff; margin-bottom:8px;"></i>
                        <span class="m-name m-payeer">Payeer</span>
                    </label>
                </div>
                <!-- Niva Calculation Display -->
                <div id="niva-calc" style="display:none; background:rgba(0,255,157,0.1); border:1px dashed var(--success); padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">
                    <small>রেট: <span id="niva-rate-disp">...</span></small><br>পাবেন: <b id="niva-amount" style="color:var(--success)">0</b> কয়েন
                </div>
                <!-- Payeer Calculation Display -->
                <div id="payeer-calc" style="display:none; background:rgba(0,170,255,0.1); border:1px dashed #00aaff; padding:10px; border-radius:8px; margin-bottom:15px; text-align:center;">
                    <small>রেট: 1$ = <span id="payeer-rate-disp">...</span>৳</small><br>পাবেন: <b id="payeer-amount" style="color:#00aaff">0</b> USD
                </div>
                
                <div class="input-group"><i class="fas fa-coins"></i><input type="number" id="w-amt" placeholder="টাকার পরিমাণ" oninput="calcConversion()"></div>
                <div class="input-group"><i class="fas fa-address-card"></i><input type="text" id="w-num" placeholder="নাম্বার / ইউজার আইডি"></div>
                <p style="text-align:center; font-size:0.8rem; color:var(--text-muted); margin-bottom:10px;">লিমিট: <span id="w-limit-text">...</span></p>
                <button class="btn btn-primary" onclick="doWithdraw()">রিকুয়েস্ট পাঠান</button>
            </div></div>
            <div class="section-header"><i class="fas fa-history"></i> ইতিহাস</div>
            <div id="withdraw-history" style="margin: 0 20px 20px;"></div>
        </div>

        <!-- ADD MONEY -->
        <div id="page-add-money" class="page-section">
            <div class="section-header"><i class="fas fa-wallet"></i> অ্যাড মানি</div>
            <div class="t-card"><div class="t-body" style="text-align:center; padding:50px 20px;">
                <i class="fab fa-telegram fa-4x" style="color:#0088cc; margin-bottom:20px;"></i>
                <h3 style="margin-bottom:10px;">টেলিগ্রাম সাপোর্ট</h3>
                <p style="color:var(--text-muted); margin-bottom:25px;">টাকা এড করতে অ্যাডমিনের সাথে যোগাযোগ করুন।</p>
                <a id="btn-admin-support" href="#" target="_blank" class="btn btn-primary" style="background:#0088cc;">
                    <i class="fab fa-telegram-plane"></i> টেলিগ্রাম অ্যাডমিন
                </a>
            </div></div>
        </div>
        
        <!-- BROADCAST -->
        <div id="page-broadcast" class="page-section">
            <div class="section-header"><i class="fas fa-video"></i> লার্নিং জোন</div>
            <div id="video-list" style="margin:0 20px;"></div>
        </div>

        <!-- NOTIFICATION -->
        <div id="page-notifications" class="page-section">
            <div class="section-header"><i class="fas fa-bell"></i> নোটিফিকেশন</div>
            <div id="n-list" style="padding-bottom:20px; margin:0 20px;"></div>
        </div>

        <!-- COUPON -->
        <div id="page-coupon" class="page-section">
             <div class="section-header"><i class="fas fa-gift"></i> কুপন</div>
             <div class="t-card"><div class="t-body">
                <div class="input-group"><i class="fas fa-ticket-alt"></i><input type="text" id="coupon-code" placeholder="কোড লিখুন"></div>
                <button class="btn btn-primary" onclick="redeemCoupon()">রিডিম করুন</button>
             </div></div>
             <h4 style="margin:25px 20px 15px; color:var(--success);">পাবলিক কুপন</h4>
             <div id="public-coupons"></div>
        </div>
    </div>

    <!-- DRAWER -->
    <div class="drawer-overlay" onclick="toggleDrawer()"></div>
    <div class="drawer">
        <div class="drawer-header"><h2>G-ZONE</h2><p style="font-size:0.8rem; color:#aaa;">Esports Platform</p></div>
        <div class="drawer-items">
            <div class="d-item" onclick="nav('page-home')"><i class="fas fa-home"></i> হোম</div>
            <div class="d-item" onclick="nav('page-profile')"><i class="fas fa-user-circle"></i> প্রোফাইল</div>
            <div class="d-item" onclick="nav('page-matches')"><i class="fas fa-gamepad"></i> আমার ম্যাচ</div>
            <div class="d-item" onclick="nav('page-withdraw')"><i class="fas fa-wallet"></i> উইথড্র</div>
            <div class="d-item" onclick="nav('page-refer')"><i class="fas fa-user-plus"></i> রেফার</div>
            <div class="d-item" onclick="nav('page-coupon')"><i class="fas fa-gift"></i> কুপন</div>
            <div class="d-item" onclick="nav('page-transfer')"><i class="fas fa-exchange-alt"></i> টাকা ট্রান্সফার</div>
            <div class="d-item" onclick="nav('page-leaderboard')"><i class="fas fa-crown"></i> লিডারবোর্ড</div>
            <div id="nav-spin-item" class="d-item" onclick="nav('page-spin')"><i class="fas fa-dharmachakra"></i> স্পিন হুইল</div>
            <div class="d-item" onclick="nav('page-broadcast')"><i class="fas fa-video"></i> লার্নিং জোন</div>
            <div class="d-item" onclick="nav('page-add-money')"><i class="fas fa-coins"></i> অ্যাড মানি</div>
        </div>
        <div class="drawer-footer">
            <div class="d-item" onclick="logout()" style="color:var(--danger); border:none; background:rgba(255,46,99,0.1); justify-content:center;"><i class="fas fa-sign-out-alt"></i> লগআউট</div>
        </div>
    </div>

    <!-- MODALS -->
    <div id="modal-area" class="hidden modal"><div class="modal-content" id="modal-content"></div></div>
    
    <div id="join-modal" class="hidden modal">
        <div class="modal-content" style="background:#1e1e2f; padding:20px; border-radius:15px; width:90%; border:1px solid var(--primary); max-width:400px;">
            <h3 style="text-align:center; color:var(--primary); margin-top:0;">টুর্নামেন্টে জয়েন করুন</h3>
            <div id="squad-tabs" class="sq-tabs hidden">
                <div class="sq-tab active" id="tab-create" onclick="switchTab('create')">স্কোয়াড কিনুন</div>
                <div class="sq-tab" id="tab-join" onclick="switchTab('join')">টিমে জয়েন করুন</div>
            </div>
            <div id="view-create">
                <p style="text-align:center; color:#aaa;">ফি: <b style="color:var(--warning)" id="j-fee">0</b></p>
                <div class="input-group"><i class="fas fa-gamepad"></i><input type="text" id="j-uid" placeholder="গেম ইউআইডি (UID)"></div>
                <div id="squad-inputs" class="hidden">
                    <div class="input-group"><i class="fas fa-users"></i><input type="text" id="j-team" placeholder="টিমের নাম"></div>
                </div>
                <button class="btn btn-primary" id="btn-conf" onclick="confirmJoin()">কনফার্ম ও পেমেন্ট</button>
            </div>
            <div id="view-join" class="hidden">
                <p style="text-align:center; color:#aaa;">লিডারের দেওয়া কোড দিন</p>
                <div class="input-group"><i class="fas fa-key"></i><input type="text" id="m-code" placeholder="টিম কোড"></div>
                <div class="input-group"><i class="fas fa-gamepad"></i><input type="text" id="m-uid" placeholder="আপনার গেম ইউআইডি (UID)"></div>
                <button class="btn btn-success" onclick="joinTeamMember()">টিমে জয়েন করুন</button>
            </div>
            <button onclick="closeJoin()" style="background:none; border:none; color:#aaa; width:100%; margin-top:10px;">বাতিল করুন</button>
        </div>
    </div>
    
    <div id="team-code-modal" class="hidden modal">
        <div class="modal-content" style="background:#1e1e2f; border:1px solid var(--success); text-align:center;">
            <h3 style="color:var(--success)">সফলভাবে স্কোয়াড তৈরি হয়েছে!</h3>
            <p style="color:#aaa; margin-top:10px;">নিচের কোডটি আপনার টিমমেটদের দিন:</p>
            <div class="cred-panel" style="margin:15px 0;">
                <div class="cred-box" style="justify-content:center; gap:10px;">
                    <span id="gen-team-code" class="cred-value" style="font-size:1.4rem;">...</span>
                    <i class="fas fa-copy" onclick="copyGenCode()" style="cursor:pointer; color:var(--primary)"></i>
                </div>
            </div>
            <button class="btn btn-primary" onclick="closeTeamCodeModal()">ঠিক আছে</button>
        </div>
    </div>
    
    <div id="info-modal" class="hidden modal">
        <div class="modal-content" style="background:#16162a; border:1px solid var(--primary);">
            <h3 style="text-align:center; color:var(--primary);">ডিটেইলস</h3>
            <div id="info-text" style="color:#ddd; white-space:pre-wrap; margin:15px 0; font-size:0.9rem;"></div>
            <button class="btn btn-secondary" onclick="document.getElementById('info-modal').classList.add('hidden')">বন্ধ করুন</button>
        </div>
    </div>

    <!-- NEW PROOF MODAL -->
    <div id="proof-modal" class="hidden modal">
        <div class="modal-content" style="background:#16162a; border:1px solid var(--primary); text-align:center;">
            <h3 style="color:var(--primary); margin-bottom:10px;">প্রুফ জমা দিন</h3>
            <p style="color:#aaa; font-size:0.9rem; margin-bottom:20px;">আপনার তথ্য কপি হয়েছে। টেলিগ্রাম বটে গিয়ে পেস্ট করুন এবং স্ক্রিনশট দিন।</p>
            
            <a id="btn-proof-link" href="#" target="_blank" class="btn btn-primary" style="background:#0088cc; margin-bottom:10px;">
                <i class="fab fa-telegram-plane"></i> প্রুফ পাঠান (Telegram)
            </a>
            
            <button class="btn btn-secondary" onclick="document.getElementById('proof-modal').classList.add('hidden')">বন্ধ করুন</button>
        </div>
    </div>

    <!-- JS LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, query, where, orderBy, addDoc, increment, arrayUnion, serverTimestamp, writeBatch, onSnapshot, getDocs, limit } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyAafXkJwyZ5F7Xuax0VktZ9cpqWD4oCvxU", authDomain: "tournament-97743.firebaseapp.com", projectId: "tournament-97743" };
        const app = initializeApp(firebaseConfig); const auth = getAuth(app); const db = getFirestore(app);
        
        let currentUserData = null;
        let sliderInterval = null;
        let nivaRate = 10;
        let payeerRate = 115; // Default payeer rate
        let proofBotUrl = ""; // Url for proof bot
        let selMatch = null;
        let allTournaments = [];
        let joinedMatchIds = new Set();
        let spinProcessing = false;
        let currentRotation = 0;
        let lastBackPress = 0;
        let minW = 50; let maxW = 10000;
        let currentHomeTab = 'BR';

        window.showToast = (msg) => { const t = document.getElementById('toast-box'); if(t) { t.innerHTML = `<i class="fas fa-info-circle"></i> ${msg}`; t.classList.add('show'); setTimeout(() => t.classList.remove('show'), 3000); } else { alert(msg); } };
        window.nav = (pid) => { document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active')); const target = document.getElementById(pid); if(target) target.classList.add('active'); if(document.querySelector('.drawer').style.transform === 'translateX(0px)') window.toggleDrawer(); if (pid === 'page-home') { history.pushState({page: 'home'}, '', '#home'); } else { history.pushState({page: pid}, '', '#' + pid.replace('page-', '')); } window.scrollTo(0,0); };
        window.selectMethod = (el) => { document.querySelectorAll('.method-card').forEach(c => c.classList.remove('active')); el.classList.add('active'); el.querySelector('input').checked = true; window.calcConversion(); }
        window.toggleAuth = () => { document.getElementById('login-form').classList.toggle('hidden'); document.getElementById('signup-form').classList.toggle('hidden'); };
        window.toggleDrawer = () => { const d=document.querySelector('.drawer'), o=document.querySelector('.drawer-overlay'); if(d.style.transform==='translateX(0px)'){d.style.transform='translateX(-100%)';o.style.display='none';}else{d.style.transform='translateX(0px)';o.style.display='block';} };
        window.closeModal = () => document.getElementById('modal-area').classList.add('hidden');
        window.closeJoin = () => document.getElementById('join-modal').classList.add('hidden');
        window.copyToClipboard = (t) => { if(navigator.clipboard && window.isSecureContext) { navigator.clipboard.writeText(t).then(()=>showToast("কপি করা হয়েছে!")).catch(err=>console.error(err)); } else { let textArea = document.createElement("textarea"); textArea.value = t; document.body.appendChild(textArea); textArea.select(); document.execCommand("Copy"); textArea.remove(); showToast("কপি করা হয়েছে!"); } };
        window.copyGenCode = () => { const code = document.getElementById('gen-team-code').innerText; window.copyToClipboard(code); }
        window.copyCustomId = () => { if(currentUserData && currentUserData.customId) { window.copyToClipboard(currentUserData.customId); } }
        window.copyReferCode = () => { if(currentUserData && currentUserData.referralCode) { window.copyToClipboard(currentUserData.referralCode); } }
        window.closeTeamCodeModal = () => { document.getElementById('team-code-modal').classList.add('hidden'); nav('page-matches'); }

        window.addEventListener('load', () => { history.pushState({page: 'home'}, '', ''); });
        window.addEventListener('popstate', (event) => { const activeSection = document.querySelector('.page-section.active'); if (activeSection && activeSection.id !== 'page-home') { document.querySelectorAll('.page-section').forEach(e => e.classList.remove('active')); document.getElementById('page-home').classList.add('active'); history.pushState({page: 'home'}, '', '#home'); } else { const now = new Date().getTime(); if (now - lastBackPress < 2000) { if(confirm("আপনি কি অ্যাপটি বন্ধ করতে চান?")) { history.back(); } else { history.pushState({page: 'home'}, '', '#home'); } } else { lastBackPress = now; showToast("বাহির হতে আবার ব্যাক চাপুন"); history.pushState({page: 'home'}, '', '#home'); } } });

        onAuthStateChanged(auth, async (user) => {
            if(user) {
                if (window.AppInventor) { window.AppInventor.setWebViewString(user.uid); }
                onSnapshot(doc(db,"users",user.uid), async d => {
                    if(d.exists()){
                        currentUserData = d.data();
                        if(currentUserData.isBlocked) { alert("Blocked by Admin"); signOut(auth); return; }
                        if(!currentUserData.referralCode) {
                             const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                             const code = Array(4).fill(0).map(()=>chars[Math.floor(Math.random()*chars.length)]).join('') + Math.floor(100 + Math.random() * 900);
                             await setDoc(doc(db, "users", user.uid), { referralCode: code, totalRefers: 0, referEarn: 0 }, { merge: true });
                        }
                        if(!currentUserData.customId) {
                             const newId = Math.floor(10000000000 + Math.random() * 90000000000).toString();
                             await setDoc(doc(db, "users", user.uid), { customId: newId }, { merge: true }); return; 
                        }
                        const balEl = document.getElementById('header-bal'); if(balEl) balEl.innerText = currentUserData.balance || 0;
                        const nameEl = document.getElementById('p-name'); if(nameEl) nameEl.innerText = currentUserData.fullName || currentUserData.username || "Gamer";
                        const idEl = document.getElementById('p-custom-id'); if(idEl) idEl.innerText = currentUserData.customId;
                        document.getElementById('my-refer-code').innerText = currentUserData.referralCode || "...";
                        document.getElementById('total-refers').innerText = currentUserData.totalRefers || 0;
                        document.getElementById('total-refer-earn').innerText = `৳${currentUserData.referEarn || 0}`;
                        const imgEl = document.getElementById('p-pic'); if(imgEl) { imgEl.src = currentUserData.photoURL || "https://via.placeholder.com/100"; imgEl.onerror = function() { this.src = "https://via.placeholder.com/100"; }; }
                        document.getElementById('auth-container').classList.add('hidden'); document.getElementById('app-container').classList.remove('hidden'); document.getElementById('loading-overlay').classList.add('hidden');
                    } else { await signOut(auth); window.location.reload(); }
                });
                loadHomeData(); loadMyMatches(user.uid); loadNotifications(user.uid); window.loadPublicCoupons(); loadWithdrawHistory(user.uid); loadConfig(); loadBroadcasts(); loadBalanceLeaderboard(); loadReferralLeaderboard();
            } else { document.getElementById('app-container').classList.add('hidden'); document.getElementById('auth-container').classList.remove('hidden'); document.getElementById('loading-overlay').classList.add('hidden'); joinedMatchIds.clear(); }
        });
        
        window.login=async()=>{try{await signInWithEmailAndPassword(auth, document.getElementById('l-email').value, document.getElementById('l-pass').value);}catch(e){showToast("Invalid Credentials")}};
        window.register=async()=>{
            try {
                const fullName = document.getElementById('r-user').value; const email = document.getElementById('r-email').value; const pass = document.getElementById('r-pass').value; const referByCode = document.getElementById('r-refer').value.trim();
                if(!fullName || !email || !pass) return showToast("Fill all fields");
                const generatedId = Math.floor(10000000000 + Math.random() * 90000000000).toString();
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
                const myReferCode = Array(4).fill(0).map(()=>chars[Math.floor(Math.random()*chars.length)]).join('') + Math.floor(100 + Math.random() * 900);
                let referrerUid = null;
                if (referByCode) { const q = query(collection(db, "users"), where("referralCode", "==", referByCode)); const snap = await getDocs(q); if (!snap.empty) { referrerUid = snap.docs[0].id; } }
                const c = await createUserWithEmailAndPassword(auth, email, pass);
                const userData = { fullName: fullName, username: fullName, email: email, balance: 0, uid: c.user.uid, customId: generatedId, referralCode: myReferCode, totalRefers: 0, referEarn: 0, createdAt: serverTimestamp() };
                if(referrerUid) { userData.referredBy = referrerUid; userData.referBonusPending = true; }
                await setDoc(doc(db, "users", c.user.uid), userData); showToast("Success!");
            } catch(e){ showToast(e.message); }
        };

        window.logout = () => { if (window.AppInventor) { window.AppInventor.setWebViewString("LOGOUT"); } signOut(auth); };

        function loadConfig() {
            onSnapshot(doc(db,"config","settings"), s=>{ 
                if(s.exists()){ 
                    const d=s.data(); 
                    nivaRate=d.nivaCoinPrice||10; 
                    payeerRate = d.payeerRate || 115; // NEW PAYEER RATE
                    proofBotUrl = d.telegramProof || d.telegramSupport; // NEW PROOF URL
                    
                    minW = d.minWithdraw || 50; maxW = d.maxWithdraw || 10000;
                    if(document.getElementById('w-limit-text')) document.getElementById('w-limit-text').innerText = `সর্বনিম্ন ৳${minW} - সর্বোচ্চ ৳${maxW}`;
                    if(document.getElementById('niva-rate-disp')) document.getElementById('niva-rate-disp').innerText=`1000=${nivaRate}TK`;
                    if(document.getElementById('payeer-rate-disp')) document.getElementById('payeer-rate-disp').innerText = payeerRate; // Set payeer rate text

                    if(document.getElementById('method-bkash')) document.getElementById('method-bkash').style.display = d.methodBkash !== false ? 'block' : 'none';
                    if(document.getElementById('method-nagad')) document.getElementById('method-nagad').style.display = d.methodNagad !== false ? 'block' : 'none';
                    if(document.getElementById('method-niva')) document.getElementById('method-niva').style.display = d.methodNiva !== false ? 'block' : 'none';
                    if(document.getElementById('method-payeer')) document.getElementById('method-payeer').style.display = d.methodPayeer !== false ? 'block' : 'none';

                    const spinItem = document.getElementById('nav-spin-item'); if(spinItem) { if(d.methodSpinWheel === false) { spinItem.style.display = 'none'; if(document.getElementById('page-spin').classList.contains('active')) nav('page-home'); } else { spinItem.style.display = 'flex'; } }
                    
                    const adminBtn = document.getElementById('btn-admin-support');
                    if(adminBtn && d.telegramSupport) { adminBtn.href = d.telegramSupport; adminBtn.classList.remove('hidden'); }
                    
                    // Set Proof Modal Button Link
                    const proofBtn = document.getElementById('btn-proof-link');
                    if(proofBtn && proofBotUrl) proofBtn.href = proofBotUrl;
                } 
            });
        }
        
        window.sendMoney = async () => {
            const targetId = document.getElementById('tf-id').value.trim(); const amount = Number(document.getElementById('tf-amount').value);
            if(!targetId || !amount || amount <= 0) return showToast("সঠিক তথ্য দিন"); if(amount > currentUserData.balance) return showToast("ব্যালেন্স নেই"); if(targetId === currentUserData.customId) return showToast("নিজেকে পাঠানো যাবে না");
            const btn = document.getElementById('btn-transfer'); btn.disabled = true; btn.innerText = "Processing...";
            try {
                const q = query(collection(db, "users"), where("customId", "==", targetId)); const querySnapshot = await getDocs(q); if(querySnapshot.empty) { throw new Error("User Not Found (ভুল আইডি)"); }
                const receiverDoc = querySnapshot.docs[0]; const receiverData = receiverDoc.data();
                const batch = writeBatch(db);
                batch.update(doc(db, "users", auth.currentUser.uid), { balance: increment(-amount) });
                batch.update(doc(db, "users", receiverDoc.id), { balance: increment(amount) });
                batch.set(doc(collection(db, "notifications")), { targetUid: auth.currentUser.uid, title: "Sent Money", body: `Sent ৳${amount} to ${receiverData.fullName} (${targetId})`, createdAt: serverTimestamp(), read: false });
                batch.set(doc(collection(db, "notifications")), { targetUid: receiverDoc.id, title: "Received Money", body: `Received ৳${amount} from ${currentUserData.fullName} (${currentUserData.customId})`, createdAt: serverTimestamp(), read: false });
                await batch.commit(); showToast("টাকা পাঠানো হয়েছে!"); document.getElementById('tf-id').value = ''; document.getElementById('tf-amount').value = ''; nav('page-home'); 
            } catch(e) { showToast(e.message); } finally { btn.disabled = false; btn.innerText = "টাকা পাঠান"; }
        }

        window.switchHomeTab = (tab) => {
            currentHomeTab = tab;
            document.querySelectorAll('.home-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(`ht-${tab}`).classList.add('active');
            renderHomeTournaments();
        }

        function renderHomeTournaments() {
            const l = document.getElementById('tournament-list'); 
            l.innerHTML='';
            const filtered = allTournaments.filter(d => { const t = d.data(); const cat = t.category || 'BR'; return cat === currentHomeTab; });
            if(filtered.length === 0) { l.innerHTML = "<p style='text-align:center; color:#aaa; margin-top:20px;'>কোন ম্যাচ নেই</p>"; return; }
            filtered.forEach(d=>{
                const t=d.data();
                const isJoined = joinedMatchIds.has(d.id);
                let showFee = t.fee;
                if(currentUserData && currentUserData.referBonusPending && t.type !== 'Squad') { showFee += 5; }
                let btn;
                if(isJoined) { btn = `<button class="btn btn-success" onclick="nav('page-matches')">আইডি পাস</button>`; } else if(t.joined >= t.total) { btn = `<button class="btn btn-secondary" disabled>FULL</button>`; } else { btn = `<button class="btn btn-primary" onclick="openJoin('${d.id}','${t.type}',${t.fee})">জয়েন (${t.type})</button>`; }
                const percent = Math.min((t.joined/t.total)*100, 100);
                let dateDisplay = t.date;
                
                l.innerHTML += `
                <div class="t-card">
                    <div class="t-img-wrap"><img src="${t.image}" class="t-img"><div class="t-type-badge">${t.type}</div><div class="t-overlay">${t.title}</div></div>
                    <div class="t-body">
                        <div class="t-stats-grid">
                            <div class="t-stat"><small>এন্ট্রি ফি</small><b>৳${showFee}</b></div>
                            <div class="t-stat"><small>বাকি আছে</small><b>${t.total-t.joined}</b></div>
                            <div class="t-stat"><small>সময়</small><b>${dateDisplay}</b></div>
                        </div>
                        <div class="progress-bar" style="height:4px;background:rgba(255,255,255,0.1);border-radius:2px;margin-bottom:15px;"><div style="height:100%;width:${percent}%;background:var(--success);border-radius:2px;"></div></div>
                        <div class="t-actions">${btn}<button class="btn btn-secondary" style="width:35%" onclick="showInfo('${(t.extraDetails||'').replace(/'/g,"\\'").replace(/\n/g,'<br>')}')">বিস্তারিত তথ্য</button></div>
                    </div>
                </div>`;
            });
        }

        function loadHomeData() {
            onSnapshot(collection(db,"sliders"), s=>{ const c=document.getElementById('banner-slider'); c.innerHTML=''; s.forEach(d=>{c.innerHTML+=`<img src="${d.data().url}" class="slide">`}); if(sliderInterval) clearInterval(sliderInterval); if(s.size>1) sliderInterval=setInterval(()=>{c.scrollLeft+=c.scrollLeft+c.offsetWidth>=c.scrollWidth?-c.scrollWidth:c.offsetWidth},3000); });
            onSnapshot(query(collection(db,"tournaments"), orderBy("date","asc")), s=>{ allTournaments = s.docs; renderHomeTournaments(); });
        }

        function loadBalanceLeaderboard() { const q = query(collection(db, "users"), orderBy("balance", "desc"), limit(10)); onSnapshot(q, (s) => { const l = document.getElementById('balance-leaderboard'); if (s.empty) { l.innerHTML = "<p style='text-align:center;color:#aaa'>Empty</p>"; return; } l.innerHTML = s.docs.map((d, i) => { const u = d.data(); const rank = i + 1; let rankClass = rank <= 3 ? `top-${rank}` : ''; return `<div class="rank-item ${rankClass}"><div class="rank-left"><span class="rank-pos">#${rank}</span><div style="font-weight:bold; color:#fff;">${u.fullName || u.username}</div></div><div style="color:var(--success); font-weight:bold;">৳${u.balance}</div></div>`; }).join(''); }); }
        function loadReferralLeaderboard() { const q = query(collection(db, "users"), orderBy("totalRefers", "desc"), limit(5)); onSnapshot(q, (s) => { const l = document.getElementById('referral-leaderboard'); if (s.empty) { l.innerHTML = "<p style='text-align:center;color:#aaa'>Empty</p>"; return; } l.innerHTML = s.docs.map((d, i) => `<div class="rank-item"><div class="rank-left"><span class="rank-pos">#${i+1}</span><div style="color:#fff;">${d.data().fullName || d.data().username}</div></div><div style="color:var(--warning); font-weight:bold;">${d.data().totalRefers} Refers</div></div>`).join(''); }); }

        window.spinWheel = async () => {
            if(spinProcessing) return;
            const amtInput = document.getElementById('spin-amt'); const amt = parseInt(amtInput.value); const wheel = document.getElementById('spin-wheel');
            if(!amt || amt < 1) return showToast("সঠিক পরিমাণ লিখুন"); if(amt > currentUserData.balance) return showToast("ব্যালেন্স নেই");
            spinProcessing = true; document.getElementById('spin-btn').disabled = true;
            try { await updateDoc(doc(db, "users", auth.currentUser.uid), { balance: increment(-amt) }); } catch(e) { showToast("Server Error"); spinProcessing = false; document.getElementById('spin-btn').disabled = false; return; }
            const durationSec = 5 + Math.random() * 5; const durationMs = durationSec * 1000;
            wheel.style.transition = `transform ${durationSec}s cubic-bezier(0.25, 0.1, 0.25, 1)`;
            const spins = 8; const degreesPerSpin = 360;
            let targetAngleFromTop = 10 + Math.random() * 70; const finalAngleRelToCircle = 360 - targetAngleFromTop;
            let currentMod = currentRotation % 360; if(currentMod < 0) currentMod += 360; 
            let addedRotation = (spins * degreesPerSpin) + (finalAngleRelToCircle - currentMod);
            if (addedRotation < degreesPerSpin) addedRotation += degreesPerSpin;
            currentRotation += addedRotation;
            wheel.style.transform = `rotate(${currentRotation}deg)`;
            setTimeout(async () => { showToast(`দুঃখিত! আপনি ${amt} টাকা হেরেছেন।`); spinProcessing = false; document.getElementById('spin-btn').disabled = false; }, durationMs + 100); 
        }

        window.openJoin = (id, type, fee) => {
            selMatch = {id, type, fee};
            document.getElementById('join-modal').classList.remove('hidden');
            let displayFee = fee; if (type !== 'Squad' && currentUserData.referBonusPending) { displayFee += 5; }
            document.getElementById('j-fee').innerText = `৳${displayFee}`;
            if(type==='Squad') { document.getElementById('squad-tabs').classList.remove('hidden'); document.getElementById('squad-inputs').classList.remove('hidden'); switchTab('create'); } else { document.getElementById('squad-tabs').classList.add('hidden'); document.getElementById('squad-inputs').classList.add('hidden'); document.getElementById('view-create').classList.remove('hidden'); document.getElementById('view-join').classList.add('hidden'); }
        }
        window.switchTab = (t) => { document.querySelectorAll('.sq-tab').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); if(t==='create'){document.getElementById('view-create').classList.remove('hidden'); document.getElementById('view-join').classList.add('hidden');} else{document.getElementById('view-create').classList.add('hidden'); document.getElementById('view-join').classList.remove('hidden');} }

        window.confirmJoin = async() => {
            const uid=document.getElementById('j-uid').value; if(!uid)return showToast("Enter UID");
            const btn = document.getElementById('btn-conf'); btn.disabled = true; btn.innerText = "Processing...";
            try {
                const checkJoin = await getDoc(doc(db, `users/${auth.currentUser.uid}/matches/${selMatch.id}`)); if(checkJoin.exists()) throw new Error("Already Joined!");
                let totalFee = selMatch.fee; let isReferralPay = false;
                if(selMatch.type !== 'Squad' && currentUserData.referBonusPending) { totalFee += 5; isReferralPay = true; }
                const uRef=doc(db,"users",auth.currentUser.uid), tRef=doc(db,"tournaments",selMatch.id);
                const uSnap=await getDoc(uRef); if(uSnap.data().balance < totalFee) throw new Error("Insufficient Balance");
                const b=writeBatch(db); b.update(uRef,{balance:increment(-totalFee)}); b.update(tRef,{joined:increment(1)});
                if(isReferralPay && currentUserData.referredBy) { b.update(uRef, { referBonusPending: false }); b.update(doc(db, "users", currentUserData.referredBy), { balance: increment(5), totalRefers: increment(1), referEarn: increment(5) }); b.set(doc(collection(db, "notifications")), { targetUid: currentUserData.referredBy, title: "Referral Bonus", body: `You earned ৳5 from referring ${currentUserData.fullName}`, createdAt: serverTimestamp(), read: false }); }
                if(selMatch.type==='Squad'){
                    const teamName = document.getElementById('j-team').value; if(!teamName) throw new Error("Enter Team Name");
                    const randomCode = Math.floor(10000 + Math.random() * 90000); const joinCode = teamName.replace(/\s+/g, '') + randomCode;
                    const tm=doc(collection(db,`tournaments/${selMatch.id}/teams`));
                    b.set(tm,{teamName, joinCode, leaderUid:auth.currentUser.uid, leaderName:uSnap.data().username, members:[{uid:auth.currentUser.uid, name:uSnap.data().username, role:'leader', gameUid:uid}]});
                    b.set(doc(db,`users/${auth.currentUser.uid}/matches/${selMatch.id}`),{tourneyId:selMatch.id, type:'squad', role:'leader', teamId:tm.id});
                    b.set(doc(db,`tournaments/${selMatch.id}/participants/${auth.currentUser.uid}`),{uid:auth.currentUser.uid, username:uSnap.data().username, ffUid:uid});
                    await b.commit(); closeJoin(); document.getElementById('gen-team-code').innerText = joinCode; document.getElementById('team-code-modal').classList.remove('hidden');
                } else {
                    b.set(doc(db,`users/${auth.currentUser.uid}/matches/${selMatch.id}`),{tourneyId:selMatch.id, type:'solo'});
                    b.set(doc(db,`tournaments/${selMatch.id}/participants/${auth.currentUser.uid}`),{uid:auth.currentUser.uid, username:uSnap.data().username, ffUid:uid});
                    await b.commit(); showToast("Joined Successfully!"); closeJoin(); nav('page-matches');
                }
            } catch(e){showToast(e.message); btn.disabled = false; btn.innerText = "Confirm";}
        }

        window.joinTeamMember = async() => {
            const code=document.getElementById('m-code').value, uid=document.getElementById('m-uid').value; if(!code || !uid) return showToast("Fill all");
            const checkJoin = await getDoc(doc(db, `users/${auth.currentUser.uid}/matches/${selMatch.id}`)); if(checkJoin.exists()) return showToast("Already Joined!");
            const q=query(collection(db,`tournaments/${selMatch.id}/teams`), where("joinCode","==",code)); const s=await getDocs(q); if(s.empty) return showToast("Invalid Team Code");
            const tm=s.docs[0]; if(tm.data().members.length>=4) return showToast("Team Full");
            const b=writeBatch(db); const name = (await getDoc(doc(db,"users",auth.currentUser.uid))).data().username;
            b.update(tm.ref,{members:arrayUnion({uid:auth.currentUser.uid, name:name, role:'member', gameUid:uid})});
            b.set(doc(db,`users/${auth.currentUser.uid}/matches/${selMatch.id}`),{tourneyId:selMatch.id, type:'squad', role:'member', teamId:tm.id});
            b.set(doc(db,`tournaments/${selMatch.id}/participants/${auth.currentUser.uid}`),{uid:auth.currentUser.uid, username:name, ffUid:uid});
            await b.commit(); showToast("Joined!"); closeJoin(); nav('page-matches');
        }
        window.leave = async(tid, tmid) => { if(!confirm("Leave?")) return; const tmRef=doc(db,`tournaments/${tid}/teams`, tmid); const s=await getDoc(tmRef); const mems=s.data().members.filter(m=>m.uid!==auth.currentUser.uid); const b=writeBatch(db); b.update(tmRef,{members:mems}); b.delete(doc(db,`users/${auth.currentUser.uid}/matches/${tid}`)); b.delete(doc(db,`tournaments/${tid}/participants/${auth.currentUser.uid}`)); await b.commit(); }
        
        function loadMyMatches(uid) {
            onSnapshot(collection(db, `users/${uid}/matches`), async (s) => {
                joinedMatchIds.clear(); s.forEach(d => joinedMatchIds.add(d.data().tourneyId)); renderHomeTournaments();
                const l = document.getElementById('my-matches-list'); if(s.empty) { l.innerHTML="<p style='text-align:center;color:#aaa;padding:20px;'>No matches joined</p>"; return; }
                const htmls = await Promise.all(s.docs.map(async d=>{
                    const m=d.data(); return new Promise(async resolve => {
                        const tSnap = await getDoc(doc(db,"tournaments",m.tourneyId));
                        if(!tSnap.exists()) { resolve(`<div class="t-card" style="border-color:red;padding:15px;text-align:center;">Match Removed</div>`); return; }
                        const t = tSnap.data(); let extra = ""; let myGameUid = "N/A";

                        // Fetch gameUid for Proof Button
                        if(m.type==='squad'){ 
                            const tmSnap = await getDoc(doc(db,`tournaments/${m.tourneyId}/teams`, m.teamId)); 
                            if(tmSnap.exists()){ 
                                const tm = tmSnap.data(); 
                                const myMem = tm.members.find(mem => mem.uid === uid);
                                if(myMem) myGameUid = myMem.gameUid;
                                extra = `<div style="background:rgba(255,255,255,0.05);padding:10px;border-radius:8px;margin-top:10px;font-size:0.9rem;">${m.role==='leader'?`<div style="background:rgba(255,204,0,0.1);color:#ffcc00;padding:5px;text-align:center;border:1px dashed #ffcc00;margin-bottom:5px;">CODE: ${tm.joinCode}</div>`:''}<div>${tm.members.map(x=>`<div>${x.name} ${x.role==='leader'?'(L)':''}</div>`).join('')}</div>${m.role!=='leader'?`<button class="btn btn-danger" style="margin-top:5px;padding:5px;font-size:0.8rem" onclick="leave('${m.tourneyId}','${m.teamId}')">Leave</button>`:''}</div>`; 
                            } 
                        } else {
                            const pSnap = await getDoc(doc(db, `tournaments/${m.tourneyId}/participants/${uid}`));
                            if(pSnap.exists()) myGameUid = pSnap.data().ffUid;
                        }

                        const showRoomId = m.privateRoomId || t.roomId; const showPassword = m.privatePassword || t.password;
                        let creds = `<div style="padding:10px;text-align:center;color:#aaa;border:1px dashed #333;margin-top:10px;">রুম আইডি এবং পাসওয়ার্ড এর জন্য অপেক্ষা করুন</div>`;
                        if(showRoomId && showPassword) { creds = `<div class="cred-panel" style="margin-top:10px;"><div class="cred-box"><span>ID: ${showRoomId}</span> <i class="fas fa-copy" style="color:var(--primary)" onclick="copyToClipboard('${showRoomId}')"></i></div><div class="cred-box"><span>PASS: ${showPassword}</span> <i class="fas fa-copy" style="color:var(--primary)" onclick="copyToClipboard('${showPassword}')"></i></div></div>`; }
                        
                        // NEW PROOF BUTTON logic
                        const proofBtn = `<button class="btn btn-primary" style="margin-top:10px; font-size:0.9rem;" onclick="handleProof('${currentUserData.customId}', '${myGameUid}', '${m.tourneyId}')"><i class="fas fa-check-circle"></i> প্রুফ দিন</button>`;

                        resolve(`<div class="t-card"><div class="t-body"><h3 style="color:var(--primary)">${t.title}</h3><small style="color:${t.status==='ongoing'?'var(--warning)':'#aaa'}">${t.status.toUpperCase()}</small>${extra}${creds}${proofBtn}</div></div>`);
                    });
                }));
                l.innerHTML = htmls.join('');
            });
        }
        
        window.handleProof = (userId, gameUid, tourneyId) => {
            const textToCopy = `User ID: ${userId}\nUid: ${gameUid}\nTournament ID: ${tourneyId}`;
            window.copyToClipboard(textToCopy);
            document.getElementById('proof-modal').classList.remove('hidden');
        };

        // UPDATED CALCULATION FOR NIVA AND PAYEER
        window.calcConversion = () => { 
            const amtEl = document.getElementById('w-amt'); 
            const methodEl = document.querySelector('input[name="w_method"]:checked'); 
            
            document.getElementById('niva-calc').style.display='none';
            document.getElementById('payeer-calc').style.display='none';

            if(methodEl && amtEl && amtEl.value) {
                if(methodEl.value === 'Niva Coin') {
                    document.getElementById('niva-calc').style.display='block';
                    document.getElementById('niva-amount').innerText = Math.floor((amtEl.value / nivaRate)*1000);
                } else if(methodEl.value === 'Payeer Dollar') {
                    document.getElementById('payeer-calc').style.display='block';
                    document.getElementById('payeer-amount').innerText = (amtEl.value / payeerRate).toFixed(2);
                }
            } 
        }
        
        document.addEventListener('change', (e) => { if(e.target.name === 'w_method') window.calcConversion(); });
        
        window.doWithdraw = async () => {
            const amtEl = document.getElementById('w-amt'); const numEl = document.getElementById('w-num'); const methodEl = document.querySelector('input[name="w_method"]:checked');
            if(!methodEl) return showToast("Select Method"); if(!amtEl || !numEl || !amtEl.value || !numEl.value) return showToast("Fill all");
            const a = Number(amtEl.value); const n = numEl.value; const m = methodEl.value;
            if(a > currentUserData.balance) return showToast("Low Balance"); if(a < minW) return showToast(`সর্বনিম্ন উইথড্র ৳${minW}`); if(a > maxW) return showToast(`সর্বোচ্চ উইথড্র ৳${maxW}`);
            const b=writeBatch(db); b.update(doc(db,"users",auth.currentUser.uid),{balance:increment(-a)}); b.set(doc(collection(db,"withdrawals")),{userId:auth.currentUser.uid, username:currentUserData.username, amount:a, number:n, method:m, status:"pending", time:serverTimestamp()});
            await b.commit(); showToast("Requested"); nav('page-home');
        }
        function loadWithdrawHistory(uid){ onSnapshot(query(collection(db,"withdrawals"),where("userId","==",uid)),s=>{ const l = s.docs.sort((a,b)=>(b.data().time?.seconds||0)-(a.data().time?.seconds||0)); document.getElementById('withdraw-history').innerHTML = s.empty ? "<p style='text-align:center;color:#aaa'>No history</p>" : l.map(d=>{ const w=d.data(), c=w.status==='pending'?'var(--warning)':(w.status==='paid'?'var(--success)':'var(--danger)'); return `<div class="t-card" style="padding:15px;display:flex;justify-content:space-between;"><b>৳${w.amount} (${w.method})</b><span style="color:${c};font-weight:bold;">${w.status}</span></div>`; }).join(''); }); }
        function loadNotifications(uid) { const q = query(collection(db, "notifications"), where("targetUid", "==", uid)); onSnapshot(q, (s) => { const list = s.docs.map(d=>({id:d.id, ...d.data()})).sort((a,b)=>(b.createdAt?.seconds||0)-(a.createdAt?.seconds||0)); const unread = list.filter(n=>!n.read).length; document.getElementById('header-badge').style.display = unread ? 'block' : 'none'; document.getElementById('n-list').innerHTML = list.length ? list.map(n => { const bg = n.read ? 'var(--glass-bg)' : 'rgba(0,242,255,0.1)'; return `<div class="t-card" style="padding:15px;background:${bg};border-color:${n.read?'var(--glass-border)':'var(--primary)'}"><b style="color:var(--primary)">${n.title}</b><p style="font-size:0.9rem;color:#ddd;margin-top:5px;">${n.body}</p></div>`; }).join('') : "<p style='text-align:center;color:#aaa'>Empty</p>"; }); }
        window.openNotifications = async () => { nav('page-notifications'); const q = query(collection(db, "notifications"), where("targetUid", "==", auth.currentUser.uid), where("read", "==", false)); const snap = await getDocs(q); const batch = writeBatch(db); snap.forEach(d => batch.update(doc(db, "notifications", d.id), { read: true })); await batch.commit(); };
        window.loadPublicCoupons = function(){ onSnapshot(query(collection(db,"coupons"),where("type","==","public")),s=>{ document.getElementById('public-coupons').innerHTML = s.empty?"<p style='text-align:center;color:#aaa'>None</p>":s.docs.map(d=>{ const c=d.data(), p=Math.min((c.used/c.max)*100,100); return `<div class="t-card" style="padding:15px; border-left:3px solid var(--success);"><div style="display:flex;justify-content:space-between;margin-bottom:10px;"><b style="font-family:monospace;font-size:1.3rem;letter-spacing:1px;">${c.code}</b><span style="color:var(--success);font-weight:bold;font-size:1.1rem;">+৳${c.bonus}</span></div><div style="height:6px;background:rgba(255,255,255,0.1);border-radius:3px;margin-bottom:5px;"><div style="height:100%;width:${p}%;background:var(--success);border-radius:3px;"></div></div><small style="color:var(--text-muted)">${c.used}/${c.max} used</small></div>`; }).join(''); }); }
        window.redeemCoupon = async () => { const code = document.getElementById('coupon-code').value.trim(); if(!code) return showToast("Enter Code"); try { const q = query(collection(db, "coupons"), where("code", "==", code)); const snap = await getDocs(q); if(snap.empty) throw "Invalid Code"; const docSnap = snap.docs[0]; const data = docSnap.data(); if(data.used >= data.max) throw "Limit Reached"; const redRef = doc(db, `coupons/${docSnap.id}/redemptions/${auth.currentUser.uid}`); const redSnap = await getDoc(redRef); if(redSnap.exists()) throw "Already Used"; const batch = writeBatch(db); batch.update(docSnap.ref, { used: increment(1) }); batch.set(redRef, { redeemedAt: serverTimestamp() }); batch.update(doc(db, "users", auth.currentUser.uid), { balance: increment(data.bonus) }); batch.set(doc(collection(db, "notifications")), { targetUid: auth.currentUser.uid, title: "Redeemed", body: `You got ${data.bonus} TK`, createdAt: serverTimestamp(), read: false }); await batch.commit(); showToast("Success!"); } catch(e) { showToast(e.message || e); } }
        window.showInfo = (d) => { document.getElementById('info-modal').classList.remove('hidden'); document.getElementById('info-text').innerText=d.replace(/<br>/g,'\n'); };
        window.updateProfilePic=async()=>{ const u=document.getElementById('new-pic-url').value; if(u) await setDoc(doc(db,"users",auth.currentUser.uid),{photoURL:u},{merge:true}); showToast("Updated"); };
        window.copyUsername=()=>copyToClipboard(currentUserData.username);
        function loadBroadcasts() { onSnapshot(collection(db,"videos"), s=>{ document.getElementById('video-list').innerHTML = s.empty ? "<p style='text-align:center;color:#aaa'>No videos</p>" : s.docs.map(d=>`<div class="video-card"><iframe src="${d.data().link}" style="width:100%;height:200px;border:none;"></iframe><div class="video-title">${d.data().title}</div></div>`).join(''); }); }
    </script>
</body>
</html>